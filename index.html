<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Merged Depot Stock — Export XLSX</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f8fafc;color:#0b1220;margin:0;padding:18px}
    .wrap{max-width:1200px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 16px;color:#475569}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input[type=file]{padding:8px;border-radius:8px;border:1px solid #e6eef6;background:white}
    button{padding:8px 12px;border-radius:8px;border:1px solid #e2e8f0;background:white;cursor:pointer}
    button.primary{background:#0ea5a4;color:white;border:none}
    select{padding:8px;border-radius:8px;border:1px solid #e2e8f0}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:white;padding:14px;border-radius:10px;border:1px solid #e6eef6}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    th{color:#64748b;font-weight:700}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700}
    .expired{background:#fee2e2;color:#7f1d1d}
    .short{background:#fff7ed;color:#7c2d12}
    .long{background:#ecfeff;color:#075985}
    .small{font-size:13px;color:#475569}
    .summary{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .summary .item{background:#f8fafc;padding:8px;border-radius:8px;border:1px solid #eef2ff;min-width:140px}
    .nowrap{white-space:nowrap}
    .pill{padding:4px 8px;border-radius:999px;font-weight:700}
    .label-expired{background:#ffefef;color:#9b1c1c}
    .label-short{background:#fff6eb;color:#9a3d00}
    .label-long{background:#e8fbff;color:#064e63}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .table-wrap{overflow:auto;max-height:520px}
    .link{color:#0ea5a4;cursor:pointer;text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:56px;height:56px;background:#ecfeff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#064e63">M</div>
      <div>
        <h1>Batch Wise Depot Report</h1>
      </div>
    </header>

    <div class="controls">
      <input id="files" type="file" accept=".xlsx,.xls,.csv" multiple />
      <button id="process" class="primary">Combine & Preview</button>
      <button id="exportXlsx">Export .xlsx (4 sheets)</button>
      <div style="margin-left:auto" class="small">Expiry displayed as <strong>MM-YYYY</strong>. Colors: red=Expired, orange=Short, blue=Long.</div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">Summary</div>
              <div class="summary">
                <div class="item">Depots: <strong id="countDepots">0</strong></div>
                <div class="item">Products: <strong id="countProducts">0</strong></div>
                <div class="item">Merged Rows: <strong id="countRows">0</strong></div>
                <div class="item">Total Qty: <strong id="countQty">0</strong></div>
              </div>
            </div>
            <div style="text-align:right">
              <div class="small">As of</div>
              <div id="asOf">-</div>
            </div>
          </div>
          <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff" />
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div class="badge expired">Expired</div>
            <div class="badge short">Short (&le; 6 months)</div>
            <div class="badge long">Long (&gt; 6 months)</div>
          </div>
        </div>

        <div id="tableContainer" style="margin-top:12px"></div>
      </div>

      <div>
        <div class="card">
          <h3 style="margin-top:0">Depot Breakdown</h3>
          <table id="depots"><thead><tr><th>Order</th><th>Depot Code</th><th>Batches</th><th>Qty</th></tr></thead><tbody></tbody></table>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Quick Actions</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <a id="downloadSample" class="link">Download Sample Excel Template</a>
<button id="saveToSheet">Save Day-wise Stock</button>
            <button id="filterExpired">Show Expired Only</button>
            <button id="filterShort">Show Short Only</button>
            <button id="filterLong">Show Long Only</button>
            <button id="filterAll">Show All</button>
<button id="filterLowStock">Show <6000 Only</button>
<div class="card" style="margin-top:12px">
  <h3 style="margin-top:0">View Saved Reports</h3>
  <div style="display:flex;flex-direction:column;gap:8px">
    <label>From Date: <input type="date" id="fromDate"></label>
    <label>To Date: <input type="date" id="toDate"></label>
    <label>Depot: 
      <select id="depotFilter">
        <option value="">All Depots</option>
      </select>
    </label>
    <button id="loadReports" class="primary">Load Reports</button>
  </div>
</div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:24px"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx-js-style.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-timezone@0.5.43/builds/moment-timezone-with-data.min.js"></script>

  <script>
    // Utilities & globals
    const fileInput = document.getElementById('files');
    const processBtn = document.getElementById('process');
    const exportBtn = document.getElementById('exportXlsx');
    const tableContainer = document.getElementById('tableContainer');
    const depotsTbody = document.querySelector('#depots tbody');
    const asOf = document.getElementById('asOf');
    asOf.textContent = moment().format('YYYY-MM-DD');

    let MERGED = []; // array of merged rows
    let DEPOT_ORDER = []; // dynamic depot order

    // normalize header key
    function keyify(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,' '); }

    // parse a workbook into records using template columns
// ✅ Full Excel parser (reads all 16 template columns correctly)
function workbookToRecords(wb, filenameFallback) {
  const records = [];

  wb.SheetNames.forEach(sn => {
    const sheet = wb.Sheets[sn];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true });
    if (!rows || rows.length === 0) return;

    // Find header row
    let headerRow = 0;
    for (let i = 0; i < Math.min(rows.length, 8); i++) {
      const r = rows[i].map(c => keyify(c));
      if (r.includes('item name') && r.includes('batch no')) {
        headerRow = i;
        break;
      }
    }

    const hdr = rows[headerRow].map(c => keyify(c));
    const data = rows.slice(headerRow + 1).filter(r => r.some(c => c));
    const idx = {};
    hdr.forEach((h, i) => (idx[h] = i));

    // Parse each record row
    data.forEach(r => {
      const rec = {};

      let dateVal = r[idx['date']];
if (typeof dateVal === 'number') {
  const jsDate = new Date(Math.round((dateVal - 25569) * 86400 * 1000));
  rec.date = moment(jsDate).format('DD-MM-YYYY');
} else if (dateVal instanceof Date) {
  rec.date = moment(dateVal).format('DD-MM-YYYY');
} else {
  rec.date = (dateVal || '').toString().trim();
}
      rec.depot_code = (r[idx['depot code']] || '').toString().trim();
      rec.depot_name = (r[idx['depot name']] || '').toString().trim();
      rec.div_code = (r[idx['div code']] || '').toString().trim();
      rec.div_name = (r[idx['div name']] || '').toString().trim();
      rec.item_name = (r[idx['item name']] || '').toString().trim();
      rec.packing = (r[idx['packing']] || '').toString().trim();
      rec.item_code = (r[idx['item code']] || '').toString().trim();
      rec.mfr = (r[idx['mfr']] || '').toString().trim();
      rec.item_group = (r[idx['item group']] || '').toString().trim();
      rec.shipper_qty = parseFloat(r[idx['shipper qty(item)']] || 0);
      rec.batch_no = (r[idx['batch no']] || '').toString().trim();

      // Handle expiry date
      let raw = r[idx['expiry date']] || '';
      let expMoment = null;
      if (raw instanceof Date) expMoment = moment(raw);
      else if (typeof raw === 'number')
        expMoment = moment(new Date(Math.round((raw - 25569) * 86400 * 1000)));
      else
        expMoment = moment(
          (raw || '').toString().trim(),
          ['MM-YYYY', 'MM/YYYY', 'DD-MM-YYYY', 'YYYY-MM-DD']
        );

      if (expMoment && expMoment.isValid()) {
        expMoment = expMoment.endOf('month');
        rec.expiry = expMoment.toDate();
        rec.expiry_mm_yyyy = expMoment.format('MM-YYYY');
      } else {
        rec.expiry = null;
        rec.expiry_mm_yyyy = '';
      }

      rec.mrp = parseFloat(r[idx['mrp']] || 0);
      rec.total_quantity = parseFloat(r[idx['total quantity']] || 0);
      rec.total_value = parseFloat(r[idx['total value']] || 0);

      if (rec.item_name && rec.item_code)
        records.push(rec);
    });
  });

  return records;
}

    // merge multiple file records into MERGED with dynamic depot columns
// ✅ Merge uploaded Excel data (preserves full template columns)
function mergeAll(fileRecordsArray) {
  MERGED = [];
  DEPOT_ORDER = [];

  const grouped = {};

  function ensureDepot(depot) {
    if (depot && !DEPOT_ORDER.includes(depot)) DEPOT_ORDER.push(depot);
  }

  fileRecordsArray.forEach(fileRec => {
    fileRec.records.forEach(r => {
      const depot = r.depot_name || r.depot_code;
      ensureDepot(depot);

      // ✅ CORRECT UNIQUE KEY
      const key = [
        r.item_code,
        r.batch_no,
        r.expiry_mm_yyyy
      ].join('|');

      if (!grouped[key]) {
        grouped[key] = {
          date: r.date,
          div_code: r.div_code,
          div_name: r.div_name,
          item_code: r.item_code,
          item_name: r.item_name,
          packing: r.packing,
          mfr: r.mfr,
          item_group: r.item_group,
          shipper_qty: r.shipper_qty,
          batch_no: r.batch_no,
          expiry_mm_yyyy: r.expiry_mm_yyyy,
          mrp: r.mrp,
          total_quantity: 0,
          total_value: 0,
          per_depot: {}
        };
      }

      // Add depot quantity
      grouped[key].per_depot[depot] =
        (grouped[key].per_depot[depot] || 0) +
        Number(r.total_quantity || 0);

      // Total totals
      grouped[key].total_quantity += Number(r.total_quantity || 0);
      grouped[key].total_value += Number(r.total_value || 0);
    });
  });

  MERGED = Object.values(grouped);
  classifyMerged();
}
// =============================
//   FIX EXPIRY TYPE DETECTION
// =============================
function classifyMerged() {
  MERGED.forEach(r => {
    
    // Case 1: expiry_mm_yyyy already exists
    if (r.expiry_mm_yyyy && typeof r.expiry_mm_yyyy === "string") {
      const m = moment(r.expiry_mm_yyyy, ["MM-YYYY", "YYYY-MM"]);
      if (m.isValid()) {
        r.expiry = m.endOf("month").toDate();
      }
    }

    // If still no expiry date → unknown
    if (!r.expiry) {
      r.expiry_type = "Unknown";
      return;
    }

    // Evaluate expiry
    const today = moment();
    const exp = moment(r.expiry);

    if (exp.isBefore(today, 'day')) {
      r.expiry_type = "Expired";
    } 
    else if (exp.diff(today, "months") <= 3) {
      r.expiry_type = "Short";
    } 
    else {
      r.expiry_type = "Long";
    }
  });
}

    // render HTML table (column-wise depots)
function renderTable(filter) {
  const depOrder = DEPOT_ORDER;
  const rows = MERGED.filter(r => !filter || r.expiry_type === filter);

  // summary counts
  document.getElementById('countDepots').textContent = depOrder.length;
  document.getElementById('countProducts').textContent = new Set(MERGED.map(r => r.item_code || r.item_name)).size;
  document.getElementById('countRows').textContent = MERGED.length;
  document.getElementById('countQty').textContent = MERGED.reduce((s, r) => s + (r.total_quantity || 0), 0);

  // depot breakdown sidebar
  depotsTbody.innerHTML = '';
  depOrder.forEach((d, idx) => {
    const qty = MERGED.reduce((s, r) => s + (r.per_depot && r.per_depot[d] ? r.per_depot[d] : 0), 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx + 1}</td><td>${escapeHtml(d)}</td><td></td><td>${qty}</td>`;
    depotsTbody.appendChild(tr);
  });

  // ===== build column-wise headers =====
  const headerCols = [
    'Date','Div Code','Div Name','Item Code','Item Name','Batch No',
    'Expiry (MM-YYYY)','MRP', ...depOrder, 'Total Quantity','Total Value','Expiry Type'
  ];

  // ===== build table =====
  let html = '<div class="table-wrap"><table><thead><tr>' +
    headerCols.map(h => `<th>${escapeHtml(h)}</th>`).join('') +
    '</tr></thead><tbody>';

  rows.forEach(r => {
    const typeLabel = r.expiry_type || '';
    const coloredType =
      typeLabel === 'Expired' ? `<span class="pill label-expired">${typeLabel}</span>` :
      typeLabel === 'Short'   ? `<span class="pill label-short">${typeLabel}</span>` :
      typeLabel === 'Long'    ? `<span class="pill label-long">${typeLabel}</span>` :
      `<span class="pill">${typeLabel}</span>`;

    html += '<tr>';
    html += `<td>${escapeHtml(r.date)}</td>`;
    html += `<td>${escapeHtml(r.div_code)}</td>`;
    html += `<td>${escapeHtml(r.div_name)}</td>`;
    html += `<td>${escapeHtml(r.item_code)}</td>`;
    html += `<td>${escapeHtml(r.item_name)}</td>`;
    html += `<td>${escapeHtml(r.batch_no)}</td>`;
    html += `<td>${escapeHtml(r.expiry_mm_yyyy)}</td>`;
    html += `<td>${r.mrp || 0}</td>`;

    // depot quantities in columns
    depOrder.forEach(d => {
      const val = (r.per_depot && r.per_depot[d]) ? r.per_depot[d] : 0;
      html += `<td>${val}</td>`;
    });

    html += `<td>${r.total_quantity || 0}</td>`;
    html += `<td>${(r.total_value || 0).toFixed(2)}</td>`;
    html += `<td>${coloredType}</td>`;
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  tableContainer.innerHTML = html;
}

    function escapeHtml(s){ if(s==null) return ''; return (''+s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    // convert MERGED to sheet data arrays (objects) with depot columns
    function buildSheetRows(filter){
      const depOrder = DEPOT_ORDER;
      const rows = MERGED.filter(r=> !filter || r.expiry_type===filter).map(r=>{
        const obj = {
          'Item Code': r.item_code || '',
          'Item Name': r.item_name || '',
          'Batch No': r.batch_no || '',
          'Expiry (MM-YYYY)': r.expiry_mm_yyyy || ''
        };
        depOrder.forEach(d => obj[d] = r.per_depot[d] || 0);
        obj['Total Quantity'] = r.total_quantity || 0;
        obj['Total Value'] = Number((r.total_value||0).toFixed(2));
        obj['Expiry Type'] = r.expiry_type || '';
        return obj;
      });
      return rows;
    }

    // Export to XLSX with 4 sheets
// ✅ Export merged data to Excel (Full Header Format)
// ==============================
//  EXPORT WITHOUT DEPOT CODE / NAME
// ==============================
function exportXlsx() {
  if (!MERGED || MERGED.length === 0) {
    alert("Upload files and preview first!");
    return;
  }

  const wb = XLSX.utils.book_new();
  const depOrder = DEPOT_ORDER;

  // Build sheet rows
  const buildSheet = (filter) => {
    return MERGED
      .filter(r => !filter || r.expiry_type === filter)
      .filter(r => (r.div_code || '').toUpperCase() !== 'G')   // ❌ Remove DIVISION G
      .map(r => {

        const row = {
          'Date': r.date || '',
          'Div Code': r.div_code || '',
          'Div Name': r.div_name || '',
          'Item Name': r.item_name || '',
          'Packing': r.packing || '',
          'Item Code': r.item_code || '',
          'MFR': r.mfr || '',
          'Item Group': r.item_group || '',
          'Shipper Qty(Item)': r.shipper_qty || 0,
          'Batch No': r.batch_no || '',
          'Expiry (MM-YYYY)': r.expiry_mm_yyyy || '',
          'MRP': r.mrp || 0
        };

        // depot columns
        depOrder.forEach(d => {
          row[d] = (r.per_depot && r.per_depot[d]) ? r.per_depot[d] : 0;
        });

        row['Total Quantity'] = r.total_quantity || 0;
        row['Total Value'] = Number(r.total_value || 0).toFixed(2);
        row['Expiry Type'] = r.expiry_type || '';

        return row;
      });
  };

  const addSheet = (title, filter) => {
    const ws = XLSX.utils.json_to_sheet(buildSheet(filter));
    XLSX.utils.book_append_sheet(wb, ws, title);
  };

  addSheet("Total Stock");
  addSheet("Long Expiry Stock", "Long");
  addSheet("Short Expiry Stock", "Short");
  addSheet("Expired Stock", "Expired");

  // LOW STOCK < 6000
  const lowSheet = MERGED
    .filter(r => r.total_quantity < 6000)
    .filter(r => (r.div_code || '').toUpperCase() !== 'G')
    .map(r => {
      const row = {
        'Date': r.date || '',
        'Div Code': r.div_code || '',
        'Div Name': r.div_name || '',
        'Item Name': r.item_name || '',
        'Packing': r.packing || '',
        'Item Code': r.item_code || '',
        'MFR': r.mfr || '',
        'Item Group': r.item_group || '',
        'Shipper Qty(Item)': r.shipper_qty || 0,
        'Batch No': r.batch_no || '',
        'Expiry (MM-YYYY)': r.expiry_mm_yyyy || '',
        'MRP': r.mrp || 0
      };

      depOrder.forEach(d => {
        row[d] = (r.per_depot && r.per_depot[d]) ? r.per_depot[d] : 0;
      });

      row['Total Quantity'] = r.total_quantity || 0;
      row['Total Value'] = Number(r.total_value || 0).toFixed(2);
      row['Expiry Type'] = r.expiry_type || '';

      return row;
    });

  const wsLow = XLSX.utils.json_to_sheet(lowSheet);
  XLSX.utils.book_append_sheet(wb, wsLow, "Low Stock (<6000)");

  // Download
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'Depot_Stock_Report.xlsx';
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 500);
}

    // event handlers
    processBtn.addEventListener('click', async ()=>{
      const files = Array.from(fileInput.files || []);
      if(files.length===0) return alert('Please select one or more depot files to upload.');
      // read each file in order and parse
      const fileRecordsArray = [];
      for(const f of files){
        try{
          const data = await f.arrayBuffer();
          const wb = XLSX.read(data, {type:'array'});
          const recs = workbookToRecords(wb, f.name);
          fileRecordsArray.push({ records: recs, filename: f.name });
        } catch(err){ console.error('Failed to parse', f.name, err); alert('Failed to parse '+f.name); return; }
      }
      // merge
      const result = mergeAll(fileRecordsArray);
      renderTable();
      alert('Combined ' + MERGED.length + ' merged rows from ' + files.length + ' files. Depots: ' + DEPOT_ORDER.join(', '));
    });

    exportBtn.addEventListener('click', ()=> exportXlsx());

    // quick filters
    document.getElementById('filterExpired').addEventListener('click', ()=> renderTable('Expired'));
    document.getElementById('filterShort').addEventListener('click', ()=> renderTable('Short'));
    document.getElementById('filterLong').addEventListener('click', ()=> renderTable('Long'));
    document.getElementById('filterAll').addEventListener('click', ()=> renderTable(null));
document.getElementById('filterLowStock').addEventListener('click', () => {
  const depOrder = DEPOT_ORDER;
  const headerCols = ['Item Code','Item Name','Batch No','Expiry (MM-YYYY)', ...depOrder, 'Total Quantity','Total Value','Expiry Type'];
  const rows = MERGED.filter(r => r.total_quantity < 6000);

  let html = '<div class="table-wrap"><table><thead><tr>' + headerCols.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  rows.forEach(r => {
    const expiryLabel = r.expiry_mm_yyyy || '';
    const typeLabel = r.expiry_type || '';
    const coloredType = typeLabel === 'Expired'
      ? `<span class="pill label-expired">${typeLabel}</span>`
      : typeLabel === 'Short'
      ? `<span class="pill label-short">${typeLabel}</span>`
      : typeLabel === 'Long'
      ? `<span class="pill label-long">${typeLabel}</span>`
      : `<span class="pill">${typeLabel}</span>`;

    html += '<tr>';
    html += `<td>${escapeHtml(r.item_code)}</td>`;
    html += `<td>${escapeHtml(r.item_name)}</td>`;
    html += `<td>${escapeHtml(r.batch_no)}</td>`;
    html += `<td>${escapeHtml(expiryLabel)}</td>`;
    depOrder.forEach(d => html += `<td>${(r.per_depot && r.per_depot[d]) ? r.per_depot[d] : 0}</td>`);
    html += `<td>${r.total_quantity || 0}</td>`;
    html += `<td>${(r.total_value || 0).toFixed(2)}</td>`;
    html += `<td>${coloredType}</td>`;
    html += '</tr>';
  });
  html += '</tbody></table></div>';

  tableContainer.innerHTML = html;
});
document.getElementById("saveToSheet").addEventListener("click", saveToSheet);

// ✅ Correct Excel Template Download (Full Header)
document.getElementById('downloadSample').addEventListener('click', () => {
  const sample = [{
    'Date': '2025-11-11',
    'Depot Code': '100',
    'Depot Name': 'Coimbatore',
    'Div Code': 'A',
    'Div Name': 'Division A',
    'Item Name': 'PRL ASYNAC AB TAB 10S',
    'Packing': '1s',
    'Item Code': 'SPE049',
    'MFR': 'GOODMAN',
    'Item Group': 'TABLET',
    'Shipper Qty(Item)': 10,
    'Batch No': 'B123',
    'Expiry Date': '09-2026',
    'MRP': 25.00,
    'Total Quantity': 120,
    'Total Value': 3000.00
  }];

  const ws = XLSX.utils.json_to_sheet(sample);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Stock Template');
  XLSX.writeFile(wb, 'Format-Sample.xlsx');
});

    function escapeHtml(s){ if(s==null) return ''; return (''+s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

function saveToSheet() {
  if (!MERGED || MERGED.length === 0) {
    alert("Please process files before saving!");
    return;
  }

  const payload = MERGED.map(r => ({
    date: r.date || '',
    depot_code: '', // Not available per merged row
    depot_name: '', // Depots are split column-wise now
    div_code: r.div_code || '',
    div_name: r.div_name || '',
    item_name: r.item_name || '',
    packing: r.packing || '',
    item_code: r.item_code || '',
    mfr: r.mfr || '',
    item_group: r.item_group || '',
    shipper_qty: r.shipper_qty || '',
    batch_no: r.batch_no || '',
    expiry_mm_yyyy: r.expiry_mm_yyyy || '',
    mrp: r.mrp || '',
    total_quantity: r.total_quantity || '',
    total_value: r.total_value || ''
  }));

  const url = "https://script.google.com/macros/s/AKfycbwEzSldNhd5jIBO0aqEis6pmUIxhvWXdj2NRW4VP0mwA9i833sNuQSAFlRbFJnP3x96pA/exec";

  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(`✔ Saved ${data.rows} rows successfully to Google Sheet.`);
      } else {
        alert(`❌ Save failed: ${data.error}`);
      }
    })
    .catch(err => {
      console.error(err);
      alert("❌ Network Issue – Failed to connect to Google Apps Script.");
    });
}


  </script>
</body>
</html>
